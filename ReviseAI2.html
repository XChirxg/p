<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReviseAI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://code.iconify.design/3/iconify.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-color: #fafafa;
            --card-bg: white;
            --text-color: #1a1a1a;
            --text-secondary: #666;
            --border-color: #e5e5e5;
            --primary-color: #007bff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --header-bg: white;
            --highlight-color: #ff6b35;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #ffffff;
            --text-secondary: #a0a0a0;
            --border-color: #404040;
            --primary-color: #4dabf7;
            --success-color: #51cf66;
            --danger-color: #ff6b6b;
            --header-bg: #2d2d2d;
            --highlight-color: #ffa726;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 100vw;
            margin: 0 auto;
            padding: 0 12px;
        }

        /* Header */
        .header {
            background: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 8px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-weight: 700;
            font-size: 20px;
            color: var(--text-color);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .coins, .stopwatch {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--card-bg);
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
            border-radius: 4px;
        }

        .stopwatch {
            cursor: default;
            font-family: 'Courier New', monospace;
        }

        .icon-button, .theme-toggle, .back-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            cursor: pointer;
            padding: 6px 8px;
            color: var(--text-color);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            border-radius: 4px;
            min-width: 32px;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-button:hover, .theme-toggle:hover, .back-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .progress-line {
            height: 2px;
            background: var(--border-color);
            margin-top: 4px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        /* Screens */
        .screen {
            display: none;
            min-height: calc(100vh - 60px);
            padding: 12px 0;
        }

        .screen.active {
            display: block;
        }

        /* Subject Input Screen */
        .subject-input {
            text-align: center;
            padding: 40px 20px;
        }

        .subject-input h1 {
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .subject-input p {
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 16px;
        }

        .input-group {
            max-width: 400px;
            margin: 0 auto 24px;
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
            background: var(--card-bg);
            color: var(--text-color);
        }

        .input-field:focus {
            border-color: var(--primary-color);
        }

        .btn {
            background: var(--text-color);
            color: var(--bg-color);
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn:hover {
            opacity: 0.8;
        }

        .btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
        }

        /* Previous Subjects */
        .previous-subjects {
            max-width: 400px;
            margin: 24px auto;
        }

        .subject-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .subject-item:hover {
            border-color: var(--primary-color);
        }

        /* Units Screen */
        .units-grid {
            display: grid;
            gap: 12px;
            margin-top: 16px;
        }

        .unit-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .unit-card:hover {
            border-color: var(--primary-color);
        }

        .unit-title {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .unit-progress {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .unit-time {
            font-size: 12px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .unit-progress-bar {
            height: 4px;
            background: var(--border-color);
            margin-top: 8px;
            overflow: hidden;
        }

        .unit-progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        /* Topic Map */
        .topic-map {
            padding: 20px 0;
        }

        .topic-path {
            display: flex;
            flex-direction: column;
            gap: 24px;
            align-items: center;
            position: relative;
        }

        .topic-node {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            padding: 16px;
            width: 280px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .topic-node.completed {
            border-color: var(--success-color);
            background: color-mix(in srgb, var(--success-color) 10%, var(--card-bg));
        }

        .topic-node.current {
            border-color: var(--primary-color);
            background: color-mix(in srgb, var(--primary-color) 10%, var(--card-bg));
        }

        .topic-node:hover {
            transform: translateY(-2px);
        }

        .topic-connector {
            width: 3px;
            height: 20px;
            background: var(--border-color);
            margin: -2px 0;
        }

        /* Cards */
        .card-container {
            margin: 0;
            background: var(--card-bg);
            border: none;
            min-height: calc(100vh - 120px);
            display: flex;
            flex-direction: column;
        }

        .card-progress-bar {
            height: 4px;
            background: var(--border-color);
            margin: 0;
        }

        .card-progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .card-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .card-text {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .card-points {
            list-style: none;
            margin-bottom: 16px;
        }

        .card-points li {
            padding: 4px 0;
            position: relative;
            padding-left: 20px;
        }

        .card-points li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--primary-color);
            font-weight: bold;
        }

        /* Text Highlighting */
        .highlight {
            background: linear-gradient(120deg, var(--highlight-color) 0%, var(--highlight-color) 100%);
            background-repeat: no-repeat;
            background-size: 100% 40%;
            background-position: 0 85%;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: 600;
            color: var(--text-color);
        }

        /* Quiz Card */
        .quiz-card {
            text-align: center;
        }

        .quiz-question {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 24px;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .quiz-option {
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quiz-option:hover {
            border-color: var(--primary-color);
        }

        .quiz-option.selected {
            border-color: var(--primary-color);
            background: color-mix(in srgb, var(--primary-color) 10%, var(--card-bg));
        }

        .quiz-option.correct {
            border-color: var(--success-color);
            background: color-mix(in srgb, var(--success-color) 10%, var(--card-bg));
        }

        .quiz-option.incorrect {
            border-color: var(--danger-color);
            background: color-mix(in srgb, var(--danger-color) 10%, var(--card-bg));
        }

        .quiz-result {
            margin-top: 16px;
            font-weight: 500;
        }

        .quiz-result.correct {
            color: var(--success-color);
        }

        .quiz-result.incorrect {
            color: var(--danger-color);
        }

        /* Navigation */
        .card-navigation {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-btn {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            color: var(--text-color);
        }

        .nav-btn:hover {
            background: var(--border-color);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-btn.primary {
            background: var(--text-color);
            color: var(--bg-color);
            border-color: var(--text-color);
        }

        .nav-btn.primary:hover {
            opacity: 0.8;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Achievement */
        .achievement {
            text-align: center;
            padding: 40px;
        }

        .achievement-icon {
            font-size: 48px;
            margin-bottom: 16px;
            animation: bounce 0.6s ease-in-out;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        /* Coin Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 8px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
        }

        .pricing-card {
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            padding: 16px;
            margin: 12px 0;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 8px;
        }

        .pricing-card:hover {
            border-color: var(--primary-color);
        }

        .pricing-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pricing-amount {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .pricing-description {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .cooldown-timer {
            background: color-mix(in srgb, var(--danger-color) 10%, var(--card-bg);
            border: 1px solid var(--danger-color);
            padding: 12px;
            margin: 12px 0;
            text-align: center;
            border-radius: 6px;
        }

        /* Responsive */
        @media (min-width: 768px) {
            .container {
                max-width: 1200px;
                padding: 0 24px;
            }
            
            .units-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .topic-node {
                width: 320px;
            }
            
            .card-container {
                max-width: 800px;
                margin: 20px auto;
                border: 1px solid var(--border-color);
            }
        }

        @media (min-width: 1024px) {
            .units-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .screen-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .screen-title {
            font-size: 20px;
            font-weight: 600;
        }

        .time-spent {
            text-align: center;
            padding: 20px;
            background: var(--bg-color);
            border-top: 1px solid var(--border-color);
            font-size: 14px;
            color: var(--text-secondary);
        }

    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="header-content">
                <div style="display: flex; align-items: center;">
                    <button id="backButton" class="back-btn" style="display: none;" onclick="goBack()" title="Go Back">
                        ←
                    </button>
                    <div class="logo">ReviseAI</div>
                </div>
                <div class="header-right">
                    <div class="coins" id="coinsDisplay" onclick="openCoinModal()">
                        <iconify-icon icon="mdi:coin"></iconify-icon>
                        <span id="coinCount">200</span>
                    </div>
                    <div class="stopwatch" id="stopwatchDisplay" style="display: none;">
                        <iconify-icon icon="mdi:timer"></iconify-icon>
                        <span id="stopwatchTime">00:00</span>
                    </div>
                    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                        <iconify-icon icon="mdi:theme-light-dark"></iconify-icon>
                    </button>
                    <button class="icon-button" onclick="toggleFullscreen()" title="Fullscreen (F11)">
                        <iconify-icon icon="mdi:fullscreen"></iconify-icon>
                    </button>
                </div>
            </div>
            <div class="progress-line">
                <div class="progress-fill" id="overallProgress" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Subject Input Screen -->
        <div class="screen active" id="subjectScreen">
            <div class="subject-input">
                <h1>Welcome to ReviseAI</h1>
                <p>Enter a subject to generate your personalized learning path</p>
                <div class="input-group">
                    <input type="text" class="input-field" id="subjectInput" placeholder="e.g., Machine Learning, Physics, History">
                </div>
                <button class="btn" onclick="generateSyllabus()" id="generateBtn">Generate Syllabus (20 coins)</button>
                
                <div class="previous-subjects" id="previousSubjects">
                    <h3 style="margin-bottom: 16px;">Previously Generated</h3>
                </div>
            </div>
        </div>

        <!-- Units Screen -->
        <div class="screen" id="unitsScreen">
            <div class="screen-header">
                <h2 class="screen-title" id="subjectTitle">Subject Units</h2>
            </div>
            <div class="units-grid" id="unitsGrid"></div>
        </div>

        <!-- Topics Screen -->
        <div class="screen" id="topicsScreen">
            <div class="screen-header">
                <h2 class="screen-title" id="unitTitle">Unit Topics</h2>
            </div>
            <div class="topic-map">
                <div class="topic-path" id="topicPath"></div>
            </div>
        </div>

        <!-- Cards Screen -->
        <div class="screen" id="cardsScreen">
            <div class="card-container">
                <div class="card-progress-bar">
                    <div class="card-progress-fill" id="cardProgress"></div>
                </div>
                <div class="card-content" id="cardContent"></div>
                <div class="card-navigation">
                    <button class="nav-btn" onclick="previousCard()" id="prevBtn">Previous</button>
                    <button class="nav-btn primary" onclick="nextCard()" id="nextBtn">Next</button>
                </div>
                <div class="time-spent" id="timeSpent"></div>
            </div>
        </div>

        <!-- Loading Screen -->
        <div class="screen" id="loadingScreen">
            <div class="loading">
                <div class="loading-spinner"></div>
                <h3>Generating Content...</h3>
                <p id="loadingText">Please wait while we create your learning materials</p>
                <div id="tokensUsed" style="margin-top: 16px; font-size: 14px; color: var(--text-secondary);"></div>
            </div>
        </div>

        <!-- Achievement Screen -->
        <div class="screen" id="achievementScreen">
            <div class="achievement">
                <div class="achievement-icon">🎉</div>
                <h2>Congratulations!</h2>
                <p id="achievementText">You completed a topic!</p>
                <button class="btn" onclick="showTopicMap()" style="margin-top: 24px;">Continue Learning</button>
            </div>
        </div>
    </div>

    <!-- Coin Modal -->
    <div class="modal" id="coinModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Buy More Coins</h3>
                <button class="close-modal" onclick="closeCoinModal()">×</button>
            </div>
            <div>
                <p><strong>Current Coins:</strong> <span id="modalCoinCount">200</span></p>
                <p style="margin-bottom: 20px; color: var(--text-secondary);">Each syllabus generation costs 20 coins</p>
                
                <div class="pricing-card" id="buyCoinsPack" onclick="buyCoins()">
                    <div class="pricing-amount">+200 Coins</div>
                    <div class="pricing-description">Buy more coins to continue learning</div>
                </div>

                <div id="cooldownTimer" class="cooldown-timer" style="display: none;">
                    <p><strong>Please wait:</strong></p>
                    <div id="cooldownTime">09:32</div>
                    <p style="font-size: 12px; margin-top: 4px;">You can buy more coins every 10 minutes</p>
                </div>
                
                <p style="margin-top: 16px; font-size: 14px; color: var(--text-secondary);">
                    * Payment integration coming soon. For now, you can get 200 coins every 10 minutes for testing.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentUser = {
            coins: parseInt(localStorage.getItem('coins')) || 200,
            subjects: JSON.parse(localStorage.getItem('subjects')) || {},
            currentSubject: null,
            currentUnit: null,
            currentTopic: null,
            lastCoinPurchase: parseInt(localStorage.getItem('lastCoinPurchase')) || 0,
            theme: localStorage.getItem('theme') || 'light'
        };

        let currentCards = [];
        let currentCardIndex = 0;
        let touchStartX = 0;
        let touchEndX = 0;
        let sessionStartTime = 0;
        let stopwatchInterval = null;
        let screenStack = [];
        let cooldownInterval = null;

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            applyTheme();
            updateCoinDisplay();
            loadPreviousSubjects();
            updateCooldownTimer();
            
            // Add touch support for card navigation
            const cardContainer = document.querySelector('.card-container');
            if (cardContainer) {
                cardContainer.addEventListener('touchstart', handleTouchStart, false);
                cardContainer.addEventListener('touchend', handleTouchEnd, false);
            }

            // F11 fullscreen support
            document.addEventListener('keydown', function(e) {
                if (e.key === 'F11') {
                    e.preventDefault();
                    toggleFullscreen();
                }
            });
        });

        // Theme Management
        function toggleTheme() {
            currentUser.theme = currentUser.theme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', currentUser.theme);
            applyTheme();
        }

        function applyTheme() {
            document.documentElement.setAttribute('data-theme', currentUser.theme);
        }

        // Update back button visibility
        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            // Update back button visibility
            const backBtn = document.getElementById('backButton');
            if (screenId === 'subjectScreen') {
                backBtn.style.display = 'none';
                screenStack = [];
            } else {
                backBtn.style.display = 'flex';
            }

            // Show/hide stopwatch
            const coinsDisplay = document.getElementById('coinsDisplay');
            const stopwatchDisplay = document.getElementById('stopwatchDisplay');
            
            if (screenId === 'cardsScreen') {
                coinsDisplay.style.display = 'none';
                stopwatchDisplay.style.display = 'flex';
                startStopwatch();
            } else {
                coinsDisplay.style.display = 'flex';
                stopwatchDisplay.style.display = 'none';
                stopStopwatch();
            }
        }

        function goBack() {
            if (screenStack.length > 0) {
                const previousScreen = screenStack.pop();
                showScreen(previousScreen);
            } else {
                showScreen('subjectScreen');
            }
        }

        // Stopwatch Management
        function startStopwatch() {
            sessionStartTime = Date.now();
            stopwatchInterval = setInterval(updateStopwatch, 1000);
        }

        function stopStopwatch() {
            if (stopwatchInterval) {
                clearInterval(stopwatchInterval);
                stopwatchInterval = null;
            }
        }

        function updateStopwatch() {
            const elapsed = Date.now() - sessionStartTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            document.getElementById('stopwatchTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Coin Management
        function updateCoinDisplay() {
            document.getElementById('coinCount').textContent = currentUser.coins;
            document.getElementById('modalCoinCount').textContent = currentUser.coins;
            localStorage.setItem('coins', currentUser.coins.toString());
        }

        function deductCoins(amount) {
            if (currentUser.coins >= amount) {
                currentUser.coins -= amount;
                updateCoinDisplay();
                return true;
            }
            return false;
        }

        function buyCoins() {
            const now = Date.now();
            const cooldownPeriod = 10 * 60 * 1000; // 10 minutes
            
            if (now - currentUser.lastCoinPurchase < cooldownPeriod) {
                alert('Please wait before buying more coins!');
                return;
            }
            
            currentUser.coins += 200;
            currentUser.lastCoinPurchase = now;
            localStorage.setItem('lastCoinPurchase', now.toString());
            updateCoinDisplay();
            updateCooldownTimer();
            alert('Successfully purchased 200 coins!');
        }

        function updateCooldownTimer() {
            const now = Date.now();
            const cooldownPeriod = 10 * 60 * 1000; // 10 minutes
            const timeSinceLastPurchase = now - currentUser.lastCoinPurchase;
            
            const buyCoinsPack = document.getElementById('buyCoinsPack');
            const cooldownTimer = document.getElementById('cooldownTimer');
            
            if (timeSinceLastPurchase < cooldownPeriod) {
                // Show cooldown
                buyCoinsPack.classList.add('disabled');
                buyCoinsPack.onclick = null;
                cooldownTimer.style.display = 'block';
                
                if (cooldownInterval) clearInterval(cooldownInterval);
                cooldownInterval = setInterval(() => {
                    const remaining = cooldownPeriod - (Date.now() - currentUser.lastCoinPurchase);
                    if (remaining <= 0) {
                        buyCoinsPack.classList.remove('disabled');
                        buyCoinsPack.onclick = buyCoins;
                        cooldownTimer.style.display = 'none';
                        clearInterval(cooldownInterval);
                    } else {
                        const minutes = Math.floor(remaining / 60000);
                        const seconds = Math.floor((remaining % 60000) / 1000);
                        document.getElementById('cooldownTime').textContent = 
                            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
            } else {
                // Enable purchase
                buyCoinsPack.classList.remove('disabled');
                buyCoinsPack.onclick = buyCoins;
                cooldownTimer.style.display = 'none';
                if (cooldownInterval) clearInterval(cooldownInterval);
            }
        }

        function openCoinModal() {
            updateCooldownTimer();
            document.getElementById('coinModal').classList.add('active');
        }

        function closeCoinModal() {
            document.getElementById('coinModal').classList.remove('active');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Text highlighting function
        function highlightImportantWords(text) {
            const importantWords = [
                'important', 'key', 'fundamental', 'essential', 'critical', 'main', 'primary', 
                'significant', 'major', 'crucial', 'vital', 'basic', 'core', 'central',
                'principle', 'concept', 'theory', 'method', 'process', 'system', 'structure',
                'function', 'property', 'characteristic', 'feature', 'element', 'component',
                'factor', 'aspect', 'effect', 'result', 'cause', 'reason', 'purpose',
                'advantage', 'disadvantage', 'benefit', 'problem', 'solution', 'approach'
            ];
            
            let highlightedText = text;
            importantWords.forEach(word => {
                const regex = new RegExp(`\\b(${word})\\b`, 'gi');
                highlightedText = highlightedText.replace(regex, '<span class="highlight">$1</span>');
            });
            
            return highlightedText;
        }

        // Subject and Syllabus Generation
        async function generateSyllabus() {
            const subject = document.getElementById('subjectInput').value.trim();
            if (!subject) {
                alert('Please enter a subject');
                return;
            }

            if (!deductCoins(20)) {
                alert('Insufficient coins! You need 20 coins to generate a syllabus.');
                return;
            }

            screenStack.push('subjectScreen');
            showScreen('loadingScreen');
            document.getElementById('loadingText').textContent = 'Generating syllabus...';

            try {
                const prompt = `Create a comprehensive UGC NET style syllabus for "${subject}". 
                Structure it as exactly 5 units, each with 8-10 specific topics. 
                Format as JSON: {
                    "subject": "${subject}",
                    "units": [
                        {
                            "title": "Unit 1: [Title]",
                            "topics": ["Topic 1", "Topic 2", ...]
                        }
                    ]
                }
                Make topics specific and academic level. No extra text, just clean JSON.`;

                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-goog-api-key': 'AIzaSyBmtnM7XNGGno0T2TB6AADnCuo2_9X1A-M'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                const data = await response.json();
                
                if (data.candidates && data.candidates[0]) {
                    const content = data.candidates[0].content.parts[0].text;
                    document.getElementById('tokensUsed').textContent = 
                        `Tokens used: ${data.usageMetadata?.totalTokenCount || 'Unknown'}`;
                    
                    try {
                        const jsonMatch = content.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const syllabusData = JSON.parse(jsonMatch[0]);
                            
                            // Save the syllabus
                            currentUser.subjects[subject] = {
                                ...syllabusData,
                                progress: {},
                                timeSpent: {},
                                createdAt: new Date().toISOString()
                            };
                            
                            localStorage.setItem('subjects', JSON.stringify(currentUser.subjects));
                            
                            // Load the subject
                            loadSubject(subject);
                        } else {
                            throw new Error('Invalid JSON format');
                        }
                    } catch (e) {
                        console.error('JSON parsing error:', e);
                        alert('Error parsing generated content. Please try again.');
                        currentUser.coins += 20; // Refund coins on error
                        updateCoinDisplay();
                    }
                } else {
                    throw new Error('No response from AI');
                }
            } catch (error) {
                console.error('Error generating syllabus:', error);
                alert('Error generating syllabus. Please try again.');
                currentUser.coins += 20; // Refund coins on error
                updateCoinDisplay();
                showScreen('subjectScreen');
            }
        }

        function loadPreviousSubjects() {
            const container = document.getElementById('previousSubjects');
            const subjects = Object.keys(currentUser.subjects);
            
            if (subjects.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.innerHTML = '<h3 style="margin-bottom: 16px;">Previously Generated</h3>';
            
            subjects.forEach(subject => {
                const div = document.createElement('div');
                div.className = 'subject-item';
                div.innerHTML = `
                    <span>${subject}</span>
                    <iconify-icon icon="mdi:chevron-right"></iconify-icon>
                `;
                div.onclick = () => loadSubject(subject);
                container.appendChild(div);
            });
        }

        function loadSubject(subjectName) {
            currentUser.currentSubject = subjectName;
            const subject = currentUser.subjects[subjectName];
            
            document.getElementById('subjectTitle').textContent = subject.subject;
            
            const unitsGrid = document.getElementById('unitsGrid');
            unitsGrid.innerHTML = '';
            
            subject.units.forEach((unit, index) => {
                const div = document.createElement('div');
                div.className = 'unit-card';
                
                const completedTopics = Object.keys(subject.progress).filter(key => 
                    key.startsWith(`${index}-`) && subject.progress[key]
                ).length;

                const totalTime = Object.keys(subject.timeSpent)
                    .filter(key => key.startsWith(`${index}-`))
                    .reduce((sum, key) => sum + (subject.timeSpent[key] || 0), 0);

                const progressPercent = (completedTopics / unit.topics.length) * 100;
                
                div.innerHTML = `
                    <div class="unit-title">${unit.title}</div>
                    <div class="unit-progress">${completedTopics}/${unit.topics.length} topics completed</div>
                    <div class="unit-time">Time spent: ${formatTime(totalTime)}</div>
                    <div class="unit-progress-bar">
                        <div class="unit-progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                `;
                
                div.onclick = () => loadUnit(index);
                unitsGrid.appendChild(div);
            });
            
            screenStack.push('subjectScreen');
            showScreen('unitsScreen');
        }

        function loadUnit(unitIndex) {
            currentUser.currentUnit = unitIndex;
            const subject = currentUser.subjects[currentUser.currentSubject];
            const unit = subject.units[unitIndex];
            
            document.getElementById('unitTitle').textContent = unit.title;
            
            const topicPath = document.getElementById('topicPath');
            topicPath.innerHTML = '';
            
            unit.topics.forEach((topic, index) => {
                if (index > 0) {
                    const connector = document.createElement('div');
                    connector.className = 'topic-connector';
                    topicPath.appendChild(connector);
                }
                
                const div = document.createElement('div');
                div.className = 'topic-node';
                
                const topicKey = `${unitIndex}-${index}`;
                const timeSpent = subject.timeSpent?.[topicKey] || 0;
                
                if (subject.progress[topicKey]) {
                    div.classList.add('completed');
                }
                
                div.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 4px;">${topic}</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">
                        ${subject.progress[topicKey] ? 'Completed' : 'Not started'}
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                        Time: ${formatTime(timeSpent)}
                    </div>
                `;
                
                div.onclick = () => loadTopic(unitIndex, index);
                topicPath.appendChild(div);
            });
            
            screenStack.push('unitsScreen');
            showScreen('topicsScreen');
        }

        async function loadTopic(unitIndex, topicIndex) {
            const subject = currentUser.subjects[currentUser.currentSubject];
            const topic = subject.units[unitIndex].topics[topicIndex];
            const topicKey = `${unitIndex}-${topicIndex}`;
            
            currentUser.currentTopic = topicIndex;
            
            // Check if cards already exist
            if (subject.cards && subject.cards[topicKey]) {
                currentCards = subject.cards[topicKey];
                startCardSession(topic);
                return;
            }
            
            if (!deductCoins(20)) {
                alert('Insufficient coins! You need 20 coins to generate topic content.');
                return;
            }
            
            screenStack.push('topicsScreen');
            showScreen('loadingScreen');
            document.getElementById('loadingText').textContent = `Generating content for: ${topic}`;
            
            try {
                const prompt = `Create educational flashcards for the topic: "${topic}" in the subject "${subject.subject}".
                
                Generate exactly 8-12 cards in this JSON format:
                {
                    "cards": [
                        {
                            "type": "content",
                            "title": "Card Title",
                            "content": "Brief explanation (2-3 sentences)",
                            "points": ["Key point 1", "Key point 2", "Key point 3"]
                        },
                        {
                            "type": "quiz",
                            "question": "Multiple choice question?",
                            "options": ["Option A", "Option B", "Option C", "Option D"],
                            "correct": 0,
                            "explanation": "Why this is correct"
                        }
                    ]
                }
                
                Rules:
                - Mix content cards and quiz cards (no two quiz cards in a row)
                - Keep content concise and educational
                - Include 3-4 quiz cards total
                - Focus on key concepts and facts
                - No unnecessary text, just pure knowledge
                - Make quiz questions test understanding, not memorization`;

                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-goog-api-key': 'AIzaSyBmtnM7XNGGno0T2TB6AADnCuo2_9X1A-M'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                const data = await response.json();
                
                if (data.candidates && data.candidates[0]) {
                    const content = data.candidates[0].content.parts[0].text;
                    document.getElementById('tokensUsed').textContent = 
                        `Tokens used: ${data.usageMetadata?.totalTokenCount || 'Unknown'}`;
                    
                    try {
                        const jsonMatch = content.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const cardsData = JSON.parse(jsonMatch[0]);
                            
                            // Save cards
                            if (!subject.cards) subject.cards = {};
                            subject.cards[topicKey] = cardsData.cards;
                            localStorage.setItem('subjects', JSON.stringify(currentUser.subjects));
                            
                            currentCards = cardsData.cards;
                            startCardSession(topic);
                        } else {
                            throw new Error('Invalid JSON format');
                        }
                    } catch (e) {
                        console.error('JSON parsing error:', e);
                        alert('Error parsing generated content. Please try again.');
                        currentUser.coins += 20; // Refund coins on error
                        updateCoinDisplay();
                        showScreen('topicsScreen');
                    }
                } else {
                    throw new Error('No response from AI');
                }
            } catch (error) {
                console.error('Error generating cards:', error);
                alert('Error generating content. Please try again.');
                currentUser.coins += 20; // Refund coins on error
                updateCoinDisplay();
                showScreen('topicsScreen');
            }
        }

        function startCardSession(topicName) {
            currentCardIndex = 0;
            updateCardDisplay();
            screenStack.push('topicsScreen');
            showScreen('cardsScreen');
        }

        function updateCardDisplay() {
            const card = currentCards[currentCardIndex];
            const cardContent = document.getElementById('cardContent');
            const cardProgress = document.getElementById('cardProgress');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            // Update progress
            cardProgress.style.width = `${((currentCardIndex + 1) / currentCards.length) * 100}%`;
            
            // Update navigation buttons
            prevBtn.disabled = currentCardIndex === 0;
            nextBtn.textContent = currentCardIndex === currentCards.length - 1 ? 'Complete' : 'Next';
            
            // Display card content with highlighting
            if (card.type === 'content') {
                cardContent.innerHTML = `
                    <div class="card-title">${highlightImportantWords(card.title)}</div>
                    <div class="card-text">${highlightImportantWords(card.content)}</div>
                    <ul class="card-points">
                        ${card.points.map(point => `<li>${highlightImportantWords(point)}</li>`).join('')}
                    </ul>
                `;
            } else if (card.type === 'quiz') {
                cardContent.innerHTML = `
                    <div class="quiz-card">
                        <div class="quiz-question">${highlightImportantWords(card.question)}</div>
                        <div class="quiz-options">
                            ${card.options.map((option, index) => 
                                `<div class="quiz-option" onclick="selectQuizOption(${index})" data-index="${index}">
                                    ${highlightImportantWords(option)}
                                </div>`
                            ).join('')}
                        </div>
                        <div class="quiz-result" id="quizResult"></div>
                    </div>
                `;
            }
        }

        function selectQuizOption(selectedIndex) {
            const card = currentCards[currentCardIndex];
            const options = document.querySelectorAll('.quiz-option');
            const result = document.getElementById('quizResult');
            
            // Clear previous selections
            options.forEach(opt => {
                opt.classList.remove('selected', 'correct', 'incorrect');
            });
            
            // Mark selected option
            options[selectedIndex].classList.add('selected');
            
            // Check if correct
            if (selectedIndex === card.correct) {
                options[selectedIndex].classList.add('correct');
                result.innerHTML = '✓ Correct! ' + highlightImportantWords(card.explanation);
                result.className = 'quiz-result correct';
                playSound('correct');
            } else {
                options[selectedIndex].classList.add('incorrect');
                options[card.correct].classList.add('correct');
                result.innerHTML = '✗ Incorrect. ' + highlightImportantWords(card.explanation);
                result.className = 'quiz-result incorrect';
                playSound('incorrect');
            }
        }

        function previousCard() {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                updateCardDisplay();
            }
        }

        function nextCard() {
            if (currentCardIndex < currentCards.length - 1) {
                currentCardIndex++;
                updateCardDisplay();
            } else {
                // Complete topic
                completeTopic();
            }
        }

        function completeTopic() {
            const subject = currentUser.subjects[currentUser.currentSubject];
            const topicKey = `${currentUser.currentUnit}-${currentUser.currentTopic}`;
            const sessionTime = Date.now() - sessionStartTime;
            
            // Mark topic as completed and save time
            if (!subject.progress) subject.progress = {};
            if (!subject.timeSpent) subject.timeSpent = {};
            
            subject.progress[topicKey] = true;
            subject.timeSpent[topicKey] = (subject.timeSpent[topicKey] || 0) + sessionTime;
            
            localStorage.setItem('subjects', JSON.stringify(currentUser.subjects));
            
            // Show time spent
            document.getElementById('timeSpent').innerHTML = `
                <strong>Session completed!</strong><br>
                Time spent: ${formatTime(sessionTime)}
            `;
            
            // Show achievement after a delay
            setTimeout(() => {
                document.getElementById('achievementText').textContent = 
                    `You completed "${subject.units[currentUser.currentUnit].topics[currentUser.currentTopic]}"!`;
                showScreen('achievementScreen');
                playSound('achievement');
            }, 2000);
        }

        function showTopicMap() {
            loadUnit(currentUser.currentUnit);
        }

        // Touch Navigation
        function handleTouchStart(e) {
            touchStartX = e.touches[0].clientX;
        }

        function handleTouchEnd(e) {
            touchEndX = e.changedTouches[0].clientX;
            handleSwipe();
        }

        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;
            
            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    // Swipe left - next card
                    nextCard();
                } else {
                    // Swipe right - previous card
                    previousCard();
                }
            }
        }

        // Sound Effects
        function playSound(type) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            let frequency;
            
            switch(type) {
                case 'correct':
                    frequency = 800;
                    break;
                case 'incorrect':
                    frequency = 300;
                    break;
                case 'achievement':
                    frequency = 1000;
                    break;
                default:
                    frequency = 440;
            }
            
            const oscillator = audioContext.createOscillator();
            const gain = audioContext.createGain();
            
            oscillator.connect(gain);
            gain.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gain.gain.setValueAtTime(0.3, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // Keyboard Navigation
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('cardsScreen').classList.contains('active')) {
                switch(e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        previousCard();
                        break;
                    case 'ArrowRight':
                    case ' ':
                        e.preventDefault();
                        nextCard();
                        break;
                }
            }
        });

        // Auto-save progress
        setInterval(function() {
            localStorage.setItem('subjects', JSON.stringify(currentUser.subjects));
            localStorage.setItem('coins', currentUser.coins.toString());
        }, 30000); // Save every 30 seconds
    </script>
</body>
</html>