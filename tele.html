<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Teleprompter</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
        }

        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            font-size: 28px;
            margin-bottom: 30px;
            color: #00d4ff;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #aaa;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .api-helper {
            font-size: 12px;
            color: #00d4ff;
            margin-top: 8px;
        }

        .api-helper a {
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .option-btn {
            padding: 12px;
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-btn.active {
            background: #00d4ff;
            color: #000;
            border-color: #00d4ff;
        }

        .option-btn:hover {
            border-color: #00d4ff;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }

        .btn-primary {
            background: #00d4ff;
            color: #000;
        }

        .btn-primary:hover {
            background: #00b8d4;
        }

        .btn-secondary {
            background: #333;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #444;
        }

        .loading {
            text-align: center;
            padding: 30px;
        }

        .spinner {
            border: 3px solid #333;
            border-top: 3px solid #00d4ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .prompter-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #000;
            position: relative;
            overflow: hidden;
        }

        .prompter-text {
            flex: 1;
            overflow-y: scroll;
            padding: 60px 80px;
            font-size: 72px;
            line-height: 1.4;
            text-align: center;
            word-wrap: break-word;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
        }

        .prompter-text::-webkit-scrollbar {
            width: 8px;
        }

        .prompter-text::-webkit-scrollbar-track {
            background: transparent;
        }

        .prompter-text::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        .prompter-text::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .controls-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            padding: 30px;
            z-index: 500;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .controls-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        .controls-bar {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px 16px;
            border-radius: 6px;
            border: 1px solid #333;
        }

        .control-group label {
            font-size: 12px;
            color: #aaa;
        }

        .control-group input, .control-group select {
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 4px;
            color: #fff;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
        }

        .control-icon {
            width: 32px;
            height: 32px;
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 4px;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-icon:hover {
            background: #00d4ff;
            color: #000;
            border-color: #00d4ff;
        }

        .control-icon.active {
            background: #00d4ff;
            color: #000;
            border-color: #00d4ff;
        }

        .bottom-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.9);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #333;
            z-index: 400;
        }

        .playback-controls {
            display: flex;
            gap: 15px;
        }

        .playback-btn {
            width: 44px;
            height: 44px;
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 6px;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
        }

        .playback-btn:hover {
            background: #00d4ff;
            color: #000;
            border-color: #00d4ff;
        }

        .timer {
            font-size: 18px;
            color: #00d4ff;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
        }

        .text-history {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .history-item {
            background: #0d0d0d;
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #333;
            font-size: 12px;
            transition: all 0.2s;
        }

        .history-item:hover {
            background: #1a1a1a;
            border-color: #00d4ff;
        }

        .mirror {
            transform: scaleX(-1);
        }

        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 120px;
            color: #00d4ff;
            z-index: 2000;
            flex-direction: column;
        }

        .countdown-number {
            font-weight: bold;
            animation: pulse 0.6s ease-out;
        }

        @keyframes pulse {
            0% { transform: scale(1.5); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: scale(1); }
        }

        .error {
            color: #ff4444;
            margin-top: 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="setupModal" class="modal-overlay">
        <div class="modal">
            <h2><i class="fas fa-cog"></i> Setup Teleprompter</h2>
            
            <div class="form-group">
                <label>Script Name</label>
                <input type="text" id="scriptName" placeholder="My Presentation">
            </div>

            <div class="form-group">
                <label>Topic</label>
                <input type="text" id="topic" placeholder="What's your presentation about?">
            </div>

            <div class="form-group">
                <label>Tone</label>
                <select id="tone">
                    <option value="professional">Professional</option>
                    <option value="casual">Casual & Friendly</option>
                    <option value="inspirational">Inspirational</option>
                    <option value="educational">Educational</option>
                    <option value="entertaining">Entertaining</option>
                </select>
            </div>

            <div class="form-group">
                <label>Word Count</label>
                <div class="options-grid">
                    <button type="button" class="option-btn" data-words="300">Short (300 words)</button>
                    <button type="button" class="option-btn" data-words="600">Medium (600 words)</button>
                    <button type="button" class="option-btn" data-words="1200">Long (1200 words)</button>
                </div>
            </div>

            <div class="form-group">
                <label>Description (Optional)</label>
                <textarea id="description" placeholder="Add any specific details or points to cover..."></textarea>
            </div>

            <div class="form-group">
                <label>Google AI API Key</label>
                <input type="password" id="apiKey" placeholder="Paste your API key here">
                <div class="api-helper">
                    Don't have an API key? <a onclick="window.open('https://aistudio.google.com/app/apikey', '_blank')">Get one free here →</a>
                </div>
                <div id="apiError" class="error"></div>
            </div>

            <div class="form-group">
                <label>Or Use Manual Text</label>
                <textarea id="manualText" placeholder="Paste or type your script here..." style="min-height: 120px;"></textarea>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="generateScript()"><i class="fas fa-sparkles"></i> Generate AI Script</button>
                <button class="btn btn-primary" onclick="useManualText()"><i class="fas fa-pen"></i> Use Manual Text</button>
            </div>

            <div id="textHistory"></div>
        </div>
    </div>

    <div id="countdownOverlay" class="countdown-overlay" style="display: none;">
        <div class="countdown-number">3</div>
    </div>

    <div class="container">
        <div class="prompter-container">
            <div class="prompter-text" id="prompterText">Tap screen twice to show controls</div>
            
            <div class="controls-overlay" id="controlsOverlay">
                <div class="controls-bar">
                    <div class="control-group">
                        <label>Speed</label>
                        <input type="range" id="speedSlider" min="0.5" max="3" step="0.1" value="1" onchange="updateSpeed(this.value)">
                        <span id="speedValue">1.0x</span>
                    </div>

                    <div class="control-group">
                        <label>Font Size</label>
                        <input type="range" id="fontSlider" min="40" max="120" step="5" value="72" onchange="updateFontSize(this.value)">
                    </div>

                    <div class="control-group">
                        <label>Theme</label>
                        <select id="themeSelect" onchange="changeTheme(this.value)">
                            <option value="dark">Dark</option>
                            <option value="light">Light</option>
                            <option value="green">Green Screen</option>
                            <option value="blue">Blue Tint</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>Font</label>
                        <select id="fontSelect" onchange="changeFont(this.value)">
                            <option value="'Segoe UI'">Segoe UI</option>
                            <option value="'Georgia'">Georgia</option>
                            <option value="'Courier New'">Courier New</option>
                            <option value="'Arial'">Arial</option>
                        </select>
                    </div>

                    <div class="control-icon" onclick="toggleMirror()" title="Mirror"><i class="fas fa-mirror"></i></div>
                    <div class="control-icon" onclick="toggleLineHeight()" title="Line Spacing"><i class="fas fa-arrows-alt-v"></i></div>
                    <div class="control-icon" onclick="setFullscreen()" title="Fullscreen"><i class="fas fa-expand"></i></div>
                    <div class="control-icon" onclick="showSettings()" title="New Script"><i class="fas fa-plus"></i></div>
                </div>
            </div>

            <div class="bottom-bar">
                <div class="playback-controls">
                    <button class="playback-btn" onclick="toggleAutoScroll()" title="Auto Scroll"><i class="fas fa-play"></i></button>
                    <button class="playback-btn" onclick="resetScroll()" title="Reset"><i class="fas fa-redo"></i></button>
                </div>
                <div class="timer" id="timer">00:00</div>
                <div class="playback-controls">
                    <button class="playback-btn" onclick="scrollUp()" title="Scroll Up"><i class="fas fa-chevron-up"></i></button>
                    <button class="playback-btn" onclick="scrollDown()" title="Scroll Down"><i class="fas fa-chevron-down"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tapCount = 0;
        let autoScrolling = false;
        let scrollSpeed = 1;
        let lineHeightMode = 1.4;
        let currentTheme = 'dark';
        let timerInterval;
        let elapsedTime = 0;

        // Load settings from cache
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('teleprompterSettings') || '{}');
            if (settings.fontSize) document.getElementById('prompterText').style.fontSize = settings.fontSize + 'px';
            if (settings.fontFamily) document.getElementById('prompterText').style.fontFamily = settings.fontFamily;
            if (settings.theme) changeTheme(settings.theme);
            if (settings.apiKey) document.getElementById('apiKey').value = settings.apiKey;
        }

        function saveSettings() {
            const settings = {
                fontSize: document.getElementById('prompterText').style.fontSize,
                fontFamily: document.getElementById('prompterText').style.fontFamily,
                theme: currentTheme,
                apiKey: document.getElementById('apiKey').value
            };
            localStorage.setItem('teleprompterSettings', JSON.stringify(settings));
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('scriptHistory') || '[]');
            const container = document.getElementById('textHistory');
            if (history.length > 0) {
                container.innerHTML = '<h3 style="font-size: 14px; margin-top: 20px; color: #aaa;">Recent Scripts</h3>';
                history.slice(-5).forEach((item, idx) => {
                    const el = document.createElement('div');
                    el.className = 'history-item';
                    el.innerHTML = `<strong>${item.name}</strong><br><span style="color: #666; font-size: 11px;">` + item.text.substring(0, 50) + '...</span>';
                    el.onclick = () => {
                        document.getElementById('prompterText').innerHTML = item.text;
                        document.getElementById('setupModal').style.display = 'none';
                        showCountdown();
                    };
                    container.appendChild(el);
                });
            }
        }

        async function generateScript() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const topic = document.getElementById('topic').value.trim();
            const tone = document.getElementById('tone').value;
            const words = document.querySelector('.option-btn.active')?.dataset.words || 600;
            const description = document.getElementById('description').value.trim();
            const scriptName = document.getElementById('scriptName').value.trim() || 'Untitled';

            if (!topic) {
                document.getElementById('apiError').textContent = 'Please enter a topic';
                return;
            }
            if (!apiKey) {
                document.getElementById('apiError').textContent = 'Please enter your API key';
                return;
            }

            document.getElementById('apiError').textContent = '';
            document.querySelector('.modal').innerHTML = '<div class="loading"><div class="spinner"></div><p>Generating your script...</p></div>';

            try {
                const prompt = `Write a ${words}-word teleprompter script about "${topic}" in a ${tone} tone. ${description ? 'Focus on: ' + description : ''}\n\nIMPORTANT: Write ONLY the script content. Make it sound natural and conversational - not like someone reading from a teleprompter. Use short sentences and pauses (represented with "..."). Use line breaks to indicate where the speaker should pause. Avoid jargon unless necessary. Make it engaging and dynamic. Format important terms in BOLD using **term** notation.`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }],
                        generationConfig: {
                            maxOutputTokens: Math.ceil(words / 0.75)
                        }
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error?.message || 'API Error: ' + response.status);
                }

                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('Invalid API response - no content generated');
                }

                let scriptText = data.candidates[0].content.parts[0].text;

                // Convert **text** to HTML bold
                scriptText = scriptText.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                
                // Save to history
                const history = JSON.parse(localStorage.getItem('scriptHistory') || '[]');
                history.push({ name: scriptName, text: scriptText });
                localStorage.setItem('scriptHistory', JSON.stringify(history.slice(-20)));
                
                // Save API key
                localStorage.setItem('teleprompterSettings', JSON.stringify({
                    fontSize: '72px',
                    fontFamily: "'Segoe UI'",
                    theme: 'dark',
                    apiKey: apiKey
                }));

                document.getElementById('prompterText').innerHTML = scriptText;
                document.getElementById('setupModal').style.display = 'none';
                showCountdown();

            } catch (error) {
                console.error('Script generation error:', error);
                const modal = document.querySelector('.modal');
                modal.innerHTML = `<div style="padding: 30px;">
                    <h2 style="color: #ff4444;"><i class="fas fa-exclamation-circle"></i> Error</h2>
                    <p style="margin: 15px 0; color: #ccc;">${error.message}</p>
                    <p style="font-size: 12px; color: #888;">Troubleshooting tips:</p>
                    <ul style="font-size: 12px; color: #888; margin: 10px 0 20px 20px;">
                        <li>Make sure your API key is correct</li>
                        <li>Check your Google AI Studio quota limits</li>
                        <li>Try a different topic or shorter word count</li>
                    </ul>
                    <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 20px;">Try Again</button>
                </div>`;
            }
        }

        function useManualText() {
            const text = document.getElementById('manualText').value.trim();
            const scriptName = document.getElementById('scriptName').value.trim() || 'Manual Script';

            if (!text) {
                alert('Please enter some text');
                return;
            }

            const history = JSON.parse(localStorage.getItem('scriptHistory') || '[]');
            history.push({ name: scriptName, text: text });
            localStorage.setItem('scriptHistory', JSON.stringify(history.slice(-20)));

            document.getElementById('prompterText').innerHTML = text;
            document.getElementById('setupModal').style.display = 'none';
            showCountdown();
        }

        function showCountdown() {
            const countdown = document.getElementById('countdownOverlay');
            countdown.style.display = 'flex';
            let count = 3;
            const interval = setInterval(() => {
                countdown.querySelector('.countdown-number').textContent = count;
                count--;
                if (count < 0) {
                    clearInterval(interval);
                    countdown.style.display = 'none';
                    startTimer();
                }
            }, 1000);
        }

        function startTimer() {
            elapsedTime = 0;
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                elapsedTime++;
                const mins = Math.floor(elapsedTime / 60);
                const secs = elapsedTime % 60;
                document.getElementById('timer').textContent = 
                    (mins < 10 ? '0' : '') + mins + ':' + (secs < 10 ? '0' : '') + secs;
            }, 1000);
        }

        document.addEventListener('click', () => {
            tapCount++;
            if (tapCount === 2) {
                const overlay = document.getElementById('controlsOverlay');
                overlay.classList.toggle('visible');
                tapCount = 0;

                if (overlay.classList.contains('visible')) {
                    setTimeout(() => {
                        overlay.classList.remove('visible');
                    }, 5000);
                }
            }
        });

        document.querySelectorAll('.option-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        function updateSpeed(value) {
            scrollSpeed = parseFloat(value);
            document.getElementById('speedValue').textContent = value + 'x';
            saveSettings();
        }

        function updateFontSize(value) {
            document.getElementById('prompterText').style.fontSize = value + 'px';
            saveSettings();
        }

        function changeTheme(theme) {
            currentTheme = theme;
            const container = document.querySelector('.prompter-container');
            const text = document.getElementById('prompterText');
            
            container.style.background = '#000';
            text.style.color = '#fff';
            
            if (theme === 'light') {
                container.style.background = '#fff';
                text.style.color = '#000';
            } else if (theme === 'green') {
                container.style.background = '#001a00';
                text.style.color = '#00ff00';
            } else if (theme === 'blue') {
                container.style.background = '#001a4d';
                text.style.color = '#00d4ff';
            }
            saveSettings();
        }

        function changeFont(font) {
            document.getElementById('prompterText').style.fontFamily = font;
            saveSettings();
        }

        function toggleMirror() {
            document.getElementById('prompterText').classList.toggle('mirror');
        }

        function toggleLineHeight() {
            lineHeightMode = lineHeightMode === 1.4 ? 2 : 1.4;
            document.getElementById('prompterText').style.lineHeight = lineHeightMode;
        }

        function scrollUp() {
            document.getElementById('prompterText').scrollTop -= 100;
        }

        function scrollDown() {
            document.getElementById('prompterText').scrollTop += 100;
        }

        function resetScroll() {
            document.getElementById('prompterText').scrollTop = 0;
        }

        function toggleAutoScroll() {
            autoScrolling = !autoScrolling;
            const btn = event.target.closest('.playback-btn');
            btn.classList.toggle('active', autoScrolling);

            if (autoScrolling) {
                const text = document.getElementById('prompterText');
                const scrollInterval = setInterval(() => {
                    if (!autoScrolling) {
                        clearInterval(scrollInterval);
                        return;
                    }
                    text.scrollTop += scrollSpeed;
                }, 50);
            }
        }

        function setFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => console.log(err));
            } else {
                document.exitFullscreen();
            }
        }

        function showSettings() {
            document.getElementById('setupModal').style.display = 'flex';
            loadHistory();
        }

        // Initialize
        loadSettings();
        loadHistory();
    </script>
</body>
</html>
